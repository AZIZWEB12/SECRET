rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Les utilisateurs peuvent créer leur propre profil, lire et mettre à jour leur propre profil.
    // Les administrateurs peuvent lire et mettre à jour n'importe quel profil.
    match /profiles/{userId} {
      allow read: if request.auth.uid == userId || get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
      allow create: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId || get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
      // Permet aux administrateurs de lister les utilisateurs
      allow list: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    // Les administrateurs peuvent créer, lire, mettre à jour et supprimer des quiz.
    // Les utilisateurs peuvent lire (get) des quiz individuels pour les passer.
    // Les administrateurs peuvent lister tous les quiz, les utilisateurs standards ne le peuvent pas pour des raisons de performance/sécurité.
    match /quizzes/{quizId} {
      allow read: if true; // Tout le monde peut lire un quiz spécifique
      allow list: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin'; // Seuls les admins peuvent lister
      allow create, update, delete: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Les utilisateurs peuvent créer leurs propres tentatives de quiz.
    // Les utilisateurs ne peuvent lire que leurs propres tentatives.
    // Les administrateurs peuvent lire toutes les tentatives.
    match /quizAttempts/{attemptId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read: if resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
      allow list: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    // Seuls les administrateurs peuvent gérer les paiements.
    match /payments/{paymentId} {
       allow read, list, create, update: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Règles pour les autres collections (PDFs, Vidéos, Formations)
    // Les admins peuvent tout faire, les utilisateurs peuvent seulement lire.
    match /pdfs/{pdfId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /videos/{videoId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    match /formations/{formationId} {
        allow read, list: if request.auth != null;
        allow create, update, delete: if get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
